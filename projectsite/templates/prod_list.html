{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="content">
    <div class="container-fluid">
        <h4 class="page-title">Product List</h4>
        <div class="row">
            <div class="col-md-12">
                <div class="card">

                    <!-- Header -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <div class="card-title">List of Products</div>
                            <span id="scanner-status" class="badge badge-secondary">Scanner: Connecting...</span>
                        </div>
                        <div class="d-flex align-items-center" style="gap:0.5rem; position: relative; z-index: 1050;">
                            
                            <!-- Product Attributes button -->
                            <a href="{% url 'product-attributes' %}" class="btn btn-info btn-rounded">
                                Product Attributes
                            </a>

                            <!-- Dropdown for archive actions -->
                            <div class="dropdown d-inline">
                                <button class="btn btn-secondary btn-rounded dropdown-toggle" type="button" id="archiveMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Archive Options
                                </button>
                                <div class="dropdown-menu" aria-labelledby="archiveMenuButton">
                                    <a class="dropdown-item" href="{% url 'products-archived-list' %}">Show Archived</a>
                                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#archiveOldProductsModal">Archive Old Data</a>
                                </div>
                            </div>
                            
                            <!-- Add Product button (standalone) -->
                            <a href="{% url 'product-add' %}" class="btn btn-success btn-rounded">
                                Add Product
                            </a>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card-body" style="position: relative; z-index: 1;">
                        <form method="get" id="filterForm" class="mb-3">

                            <!-- Other Filters Row -->
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" name="search" class="form-control"
                                        style="width:350px;" placeholder="Search Product Type, Variant, or Size..." value="{{ request.GET.search }}">
                                </div>
                                <div class="col-md-2">
                                    <input type="date" name="date_created" class="form-control"
                                           placeholder="Filter by Date"
                                           value="{{ request.GET.date_created }}">
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group">
                                        <input type="text" name="barcode" id="barcode-search" class="form-control"
                                            placeholder="ðŸ” Scan or enter barcode..." value="{{ request.GET.barcode }}">
                                    </div>
                                    <small id="barcode-status" class="form-text text-muted">Ready to scan...</small>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" onclick="window.location.href=window.location.pathname" class="btn btn-secondary" title="Reset filters">
                                        <i class="la la-times"></i>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Bulk Action Buttons -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-danger btn-rounded" id="bulkDeleteBtn" style="display:none;" onclick="bulkDelete()">
                                <i class="la la-trash"></i> Delete Selected
                            </button>
                            <button type="button" class="btn btn-warning btn-rounded" id="bulkArchiveBtn" style="display:none;" onclick="bulkArchive()">
                                <i class="la la-archive"></i> Archive Selected
                            </button>
                        </div>

                        <!-- Table -->
                        <table class="table table-striped mt-3" id="productsTable">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 40px;">
                                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                                    </th>
                                    <th scope="col">Product</th>
                                    <th scope="col">Unit Price</th>
                                    <th scope="col">SRP Price</th>
                                    <th scope="col">Date Created</th>
                                    <th scope="col" class="text-nowrap">Details</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                {% for object in products %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="row-checkbox" value="{{ object.id }}" onchange="updateBulkButtons()">
                                    </td>
                                    <td>{{ object.product_type.name }} - {{ object.variant.name }} ({{ object.size.size_label }} {{ object.size_unit.unit_name }})</td>
                                    <td>{{ object.unit_price.unit_price }}</td>
                                    <td>{{ object.srp_price.srp_price }}</td>
                                    <td>{{ object.date_created|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <a href="#" data-toggle="modal" data-target="#viewProductModal{{ object.id }}" class="text-secondary" title="View">
                                            <i class="la la-eye la-lg"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{% url 'product-edit' object.id %}" class="text-primary" title="Edit">
                                            <i class="la la-edit la-lg"></i>
                                        </a>
                                        &nbsp;&nbsp;
                                        <a href="#" data-toggle="modal" data-target="#archiveProductModal{{ object.id }}" class="text-warning" title="Archive">
                                            <i class="la la-archive la-lg"></i>
                                        </a>
                                        {% if user.is_superuser %}
                                        &nbsp;&nbsp;
                                        <a href="#" data-toggle="modal" data-target="#deleteProductModal{{ object.id }}" class="text-danger" title="Delete">
                                            <i class="la la-trash la-lg"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center">No products found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <!-- Pagination -->
                        <div class="pagination-container">
                            {% include 'includes/pagination.html' with products=products query_params=query_params %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Individual Product Modals -->
<div id="productModalsContainer">
    {% for object in products %}
    <!-- Archive Modal for {{ object.product_type.name }} -->
    <div class="modal fade" id="archiveProductModal{{ object.id }}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Archive</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to archive this product?
                </div>
                <div class="modal-footer">
                    <form method="post" action="{% url 'product-archive' object.id %}" onsubmit="handleArchiveSubmit(event, '{{ object.product_type.name }} - {{ object.variant.name }}')">
                        {% csrf_token %}
                        <input type="hidden" name="page" value="{{ request.GET.page }}">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Archive</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View Modal for {{ object.product_type.name }} -->
    <div class="modal fade" id="viewProductModal{{ object.id }}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ object.product_type.name }} - {{ object.variant.name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% if object.photo %}
                        <img src="{{ object.photo.url }}" class="img-fluid mb-3" style="max-height:300px;">
                    {% else %}
                        <p><em>No photo available</em></p>
                    {% endif %}
                    
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p>{{ object.description|default:"No description provided." }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Barcode:</strong>
                        <p>{{ object.barcode|default:"No barcode available" }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Recipe:</strong>
                        {% if object.recipes.all %}
                            <ul class="list-unstyled">
                                {% for recipe in object.recipes.all %}
                                    <li>â€¢ {{ recipe.material.name }} - {{ recipe.quantity_needed }} {{ recipe.material.unit.unit_name }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p><em>No raw materials assigned</em></p>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal for {{ object.product_type.name }} -->
    <div class="modal fade" id="deleteProductModal{{ object.id }}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete:
                    <strong>{{ object.product_type.name }} - {{ object.variant.name }} - {{ object.size.size_label }} {{ object.size_unit.unit_name }}</strong>?
                </div>
                <div class="modal-footer">
                    <form method="post" action="{% url 'product-delete' object.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="page" value="{{ request.GET.page }}">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Check for success message after page reload
    const archiveSuccess = sessionStorage.getItem('archiveSuccess');
    if (archiveSuccess) {
        showToast(archiveSuccess, 'success');
        sessionStorage.removeItem('archiveSuccess');
    }
    
    const form = document.getElementById("filterForm");
    const barcodeInput = document.getElementById("barcode-search");
    const barcodeStatus = document.getElementById("barcode-status");
    const scannerStatus = document.getElementById("scanner-status");

    let typingTimer;
    const debounceTime = 600;
    let socket = null;
    let reconnectTimer = null;
    let lastScannedBarcode = "";

    // Update scanner status badge
    function updateScannerStatus(text, className) {
        scannerStatus.textContent = `Scanner: ${text}`;
        scannerStatus.className = `badge ${className}`;
    }

    // Update barcode status message
    function updateBarcodeStatus(text, color = "text-muted") {
        barcodeStatus.textContent = text;
        barcodeStatus.className = `form-text ${color}`;
    }

    // Flash input border
    function flashInput(input, success = true) {
        const originalBorder = input.style.border;
        input.style.border = success ? "2px solid #28a745" : "2px solid #ffc107";
        input.style.transition = "border 0.3s ease";
        
        setTimeout(() => {
            input.style.border = originalBorder;
        }, 800);
    }

    // WebSocket connection for scanner
    function connectWebSocket() {
        if (socket) {
            socket.close();
        }

        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsUrl = `${protocol}${window.location.host}/ws/scan/`;

        console.log("ðŸ”Œ Connecting to scanner:", wsUrl);
        updateScannerStatus("Connecting...", "badge-warning");

        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            console.log("âœ… Scanner connected");
            updateScannerStatus("Connected", "badge-success");
            updateBarcodeStatus("âœ“ Scanner ready. Scan a barcode to search...", "text-success");
            
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
        };

        socket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                const barcode = data.barcode;

                if (!barcode) return;

                console.log("ðŸ“¦ Scanned barcode:", barcode);

                // Prevent duplicate scans within 1 second
                if (barcode === lastScannedBarcode) {
                    console.log("âš ï¸ Duplicate scan ignored");
                    flashInput(barcodeInput, false);
                    return;
                }

                lastScannedBarcode = barcode;
                setTimeout(() => { lastScannedBarcode = ""; }, 1000);

                // Update barcode input and submit form
                barcodeInput.value = barcode;
                flashInput(barcodeInput, true);
                
                const now = new Date().toLocaleTimeString();
                updateBarcodeStatus(`âœ“ Scanned: ${barcode} at ${now}`, "text-success");
                
                // Auto-submit form to search
                setTimeout(() => {
                    fetchProducts(true);
                }, 300);

            } catch (err) {
                console.error("âŒ Error processing scan:", err);
                updateBarcodeStatus("âœ— Error processing barcode", "text-danger");
            }
        };

        socket.onclose = function(e) {
            console.log("ðŸ”Œ Disconnected:", e.code);
            updateScannerStatus("Disconnected", "badge-danger");
            updateBarcodeStatus("âœ— Scanner disconnected. Reconnecting...", "text-warning");

            // Auto-reconnect after 3 seconds
            if (!reconnectTimer) {
                reconnectTimer = setTimeout(() => {
                    console.log("ðŸ”„ Reconnecting...");
                    connectWebSocket();
                }, 3000);
            }
        };

        socket.onerror = function(err) {
            console.error("âš ï¸ WebSocket error:", err);
            updateScannerStatus("Error", "badge-danger");
            updateBarcodeStatus("âœ— Connection error", "text-danger");
        };
    }

    // Start WebSocket connection
    connectWebSocket();

    // Manual input handling
    barcodeInput.addEventListener("input", function() {
        if (this.value.length > 0) {
            updateBarcodeStatus(`Searching for: ${this.value}`, "text-info");
        } else {
            updateBarcodeStatus("Ready to scan...", "text-muted");
        }
    });

    // AJAX fetch function
    function fetchProducts(resetPage = true) {
        const params = new URLSearchParams(window.location.search);
        const formData = new FormData(form);
        
        // Update params with form data
        for (let [key, value] of formData.entries()) {
            if (value) {
                params.set(key, value);
            } else {
                params.delete(key);
            }
        }
        
        // Reset to page 1 when filters change
        if (resetPage) {
            params.delete("page");
        }
        
        const url = "/products/?" + params.toString();
        
        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                
                // Replace table body
                const newRows = doc.querySelector("#productsTable tbody");
                const currentTable = document.querySelector("#productsTable tbody");
                if (newRows && currentTable) currentTable.innerHTML = newRows.innerHTML;
                
                // Replace pagination
                const newPagination = doc.querySelector(".pagination-container");
                const currentPagination = document.querySelector(".pagination-container");
                if (newPagination && currentPagination) currentPagination.innerHTML = newPagination.innerHTML;
                
                // Replace modals
                const newModals = doc.querySelector("#productModalsContainer");
                const currentModals = document.querySelector("#productModalsContainer");
                if (newModals && currentModals) currentModals.innerHTML = newModals.innerHTML;
                
                // Clean up any lingering modal backdrops
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
                $('body').css('padding-right', '');
                
                // Update URL without page reload
                window.history.pushState({}, '', url);
            })
            .catch(err => console.error("Error fetching products:", err));
    }
    
    // Auto-submit form on input change (with debounce)
    form.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", () => fetchProducts(true));
        input.addEventListener("keyup", () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                fetchProducts(true);
            }, debounceTime);
        });
    });
    
    // Handle pagination clicks
    document.addEventListener("click", function(e) {
        if (e.target.closest(".pagination a")) {
            e.preventDefault();
            const link = e.target.closest("a");
            const url = link.getAttribute("href");
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    
                    // Replace table body
                    const newRows = doc.querySelector("#productsTable tbody");
                    const currentTable = document.querySelector("#productsTable tbody");
                    if (newRows && currentTable) currentTable.innerHTML = newRows.innerHTML;
                    
                    // Replace pagination
                    const newPagination = doc.querySelector(".pagination-container");
                    const currentPagination = document.querySelector(".pagination-container");
                    if (newPagination && currentPagination) currentPagination.innerHTML = newPagination.innerHTML;
                    
                    // Replace modals
                    const newModals = doc.querySelector("#productModalsContainer");
                    const currentModals = document.querySelector("#productModalsContainer");
                    if (newModals && currentModals) currentModals.innerHTML = newModals.innerHTML;
                    
                    // Clean up any lingering modal backdrops
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open');
                    $('body').css('padding-right', '');
                    
                    // Update URL without page reload
                    window.history.pushState({}, '', url);
                    
                    // Scroll to top of table
                    document.querySelector(".card").scrollIntoView({ behavior: "smooth" });
                })
                .catch(err => console.error("Error fetching products:", err));
        }
    });

    // Cleanup on page unload
    window.addEventListener("beforeunload", function() {
        if (socket) socket.close();
        if (reconnectTimer) clearTimeout(reconnectTimer);
    });
});

// Handle archive form submission with toast
function handleArchiveSubmit(event, productName) {
    event.preventDefault();
    const form = event.target;
    
    // Close the modal
    $(form).closest('.modal').modal('hide');
    
    // Submit form via fetch
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            // Store success message in sessionStorage
            sessionStorage.setItem('archiveSuccess', `Product "${productName}" archived successfully!`);
            // Reload page immediately
            window.location.reload();
        } else {
            showToast('Failed to archive product. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Archive error:', error);
        showToast('An error occurred while archiving the product.', 'error');
    });
}

// Bulk selection functions
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkButtons();
}

function updateBulkButtons() {
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkArchiveBtn = document.getElementById('bulkArchiveBtn');
    
    if (checkedBoxes.length > 0) {
        bulkDeleteBtn.style.display = 'inline-block';
        bulkArchiveBtn.style.display = 'inline-block';
    } else {
        bulkDeleteBtn.style.display = 'none';
        bulkArchiveBtn.style.display = 'none';
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.row-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedBoxes.length === allCheckboxes.length;
}

function getSelectedIds() {
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    return Array.from(checkedBoxes).map(cb => cb.value);
}

function bulkDelete() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('Please select at least one product', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedIds.length} product(s)?`)) {
        return;
    }
    
    // Create form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('ids', selectedIds.join(','));
    
    fetch('{% url "product-bulk-delete" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast(data.message || 'Failed to delete products', 'error');
        }
    })
    .catch(error => {
        console.error('Bulk delete error:', error);
        showToast('An error occurred while deleting products', 'error');
    });
}

function bulkArchive() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('Please select at least one product', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to archive ${selectedIds.length} product(s)?`)) {
        return;
    }
    
    // Create form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('ids', selectedIds.join(','));
    
    fetch('{% url "product-bulk-archive" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast(data.message || 'Failed to archive products', 'error');
        }
    })
    .catch(error => {
        console.error('Bulk archive error:', error);
        showToast('An error occurred while archiving products', 'error');
    });
}
</script>

<div class="modal fade" id="archiveOldProductsModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Bulk Archive</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        Are you sure you want to archive all products created more than one year ago?
      </div>
      <div class="modal-footer">
        <form method="post" action="{% url 'products-archive-old' %}">
          {% csrf_token %}
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Yes, Archive</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}
