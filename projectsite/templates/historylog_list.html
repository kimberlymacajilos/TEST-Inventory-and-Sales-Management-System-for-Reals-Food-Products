{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="content">
  <div class="container-fluid">
    <h4 class="page-title">History Log</h4>
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <!-- Header: title + filters -->
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <div class="card-title">List of History</div>
            </div>
          </div>
          <div class="card-body">
            <form method="get" id="filterForm" class="d-flex align-items-center" style="gap:0.5rem;">
              <!-- Admin Filter -->
              <select name="admin" id="adminFilter" class="form-control auto-submit" style="width:160px;">
                <option value="">All Admins</option>
                {% for admin in admins %}
                  <option value="{{ admin }}" {% if request.GET.admin == admin|stringformat:'s' %}selected{% endif %}>{{ admin }}</option>
                {% endfor %}
              </select>
              
              <!-- Log Filter -->
              <select name="log" id="logFilter" class="form-control auto-submit" style="width:180px;">
                <option value="">All Logs</option>
                {% for log in logs %}
                  <option value="{{ log }}" {% if request.GET.log == log|stringformat:'s' %}selected{% endif %}>{{ log }}</option>
                {% endfor %}
              </select>
              
              <!-- Date Filter -->
              <input type="month" id="dateFilter" name="date" class="form-control auto-submit" style="width:170px;" value="{{ request.GET.date }}">
              
              <!-- Reset Button -->
              <a href="{% url 'history_log' %}" class="btn btn-secondary ms-auto">
                <i class="fas fa-undo"></i> Reset
              </a>
              
              <!-- Loading Indicator -->
              <div class="spinner-border text-primary d-none" id="loadingSpinner" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </form>
          </div>
          <!-- Table -->
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped" id="historyTable">
                <thead>
                  <tr>
                    <th scope="col">Admin</th>
                    <th scope="col">Log</th>
                    <th scope="col">Entity</th>
                    <th scope="col">Details</th>
                    <th scope="col">Date</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody">
                  {% if object_list %}
                    {% for object in object_list %}
                    <tr>
                      <td>{{ object.admin.username }}</td>
                      <td>{{ object.log_type.category }}</td>
                      <td>{{ object.get_entity_display }}</td>
                      <td>{{ object.get_details_display }}</td>
                      <td>{{ object.log_date|date:"M j, Y h:i A" }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="5" class="text-center">No history found.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination with preserved filters -->
            {% include 'includes/pagination.html' %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    // Function to show loading spinner
    function showLoading() {
      if (loadingSpinner) loadingSpinner.classList.remove('d-none');
      document.body.style.cursor = 'wait';
    }
    
    // Auto-submit form when any filter changes
    document.querySelectorAll('.auto-submit').forEach(element => {
      element.addEventListener('change', function() {
        showLoading();
        form.submit();
      });
    });
    
    // Handle pagination clicks
    document.querySelectorAll('.pagination-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        showLoading();
        window.location.href = this.href;
      });
    });
    
    // Show loading spinner when form is submitted
    if (form) {
      form.addEventListener('submit', showLoading);
    }
  });
</script>

{% endblock %}