{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="content">
  <div class="container-fluid">
    <h4 class="page-title">
      <a href="{% url 'product-batch-list' %}" class="btn btn-link p-0 mr-2" title="Back to Product Batches">
        <i class="la la-arrow-left" style="font-size: 24px;"></i>
      </a>
      Bulk Add Product Batches
    </h4>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Bulk Add Product Batches</div>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}

          <!-- Products Table -->
          <div class="mt-3">
            <h5>Products</h5>

          <!-- Scanner Status -->
          <div class="text-dark mb-3">
          
            <span id="scanner-status" class="badge badge-secondary">Connecting...</span>
          </div>

          <!-- Batch Details -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ form.manufactured_date.id_for_label }}" class="font-weight-bold">Manufactured Date</label>
                <input type="date" 
                       id="{{ form.manufactured_date.id_for_label }}" 
                       name="{{ form.manufactured_date.name }}" 
                       class="form-control" 
                       placeholder="Select Manufactured Date"
                       value="{{ form.manufactured_date.value|default:'' }}">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="font-weight-bold d-block">Options</label>
                <div class="form-check mt-2">
                  <input type="checkbox" 
                         name="{{ form.deduct_raw_material.name }}" 
                         id="{{ form.deduct_raw_material.id_for_label }}"
                         class="form-check-input green-checkbox"
                         {% if form.deduct_raw_material.value %}checked{% endif %}>
                  <label class="form-check-label" for="{{ form.deduct_raw_material.id_for_label }}">
                    Deduct Raw Materials
                  </label>
                </div>
              </div>
            </div>
          </div>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Current Stock</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody>
                {% for p in products %}
                <tr data-barcode="{{ p.product.barcode }}">
                  <td>{{ p.product }}</td>
                  <td>{{ p.product.productinventory.total_stock|floatformat:0 }}</td>
                  <td>{{ p.qty_field }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Submit Button -->
          <div class="form-group mt-3">
            <button type="submit" class="btn btn-success btn-rounded">Save Batches</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Beep Sound (NEW) -->
<audio id="beep-sound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
</audio>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const manufacturedDateInput = document.getElementById('{{ form.manufactured_date.id_for_label }}');
  if (manufacturedDateInput && !manufacturedDateInput.value) {
    const today = new Date().toISOString().split('T')[0];
    manufacturedDateInput.value = today;
  }

  const statusBadge = document.getElementById("scanner-status");
  const beepSound = document.getElementById("beep-sound");
  
  let socket = null;
  let reconnectTimer = null;

  function updateStatus(text, className) {
    statusBadge.textContent = text;
    statusBadge.className = `badge ${className}`;
  }

  function playBeep() {
    if (beepSound) {
      beepSound.currentTime = 0;
      beepSound.play().catch(err => console.log("Audio blocked:", err));
    }
  }

  function flashRow(row) {
    row.style.backgroundColor = "#d4edda";
    setTimeout(() => {
      row.style.backgroundColor = "";
    }, 800);
  }

  function connectWebSocket() {
    if (socket) {
      socket.close();
    }

    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const wsUrl = `${protocol}${window.location.host}/ws/scan/`;

    console.log("üîå Connecting to:", wsUrl);
    updateStatus("Connecting...", "badge-warning");

    socket = new WebSocket(wsUrl);

    socket.onopen = function() {
      console.log("‚úÖ Scanner connected");
      updateStatus("Connected", "badge-success");
      
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
    };

    socket.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);
        const barcode = data.barcode;

        if (!barcode) return;

        console.log("üì¶ Scanned barcode:", barcode);

        // Find the row with matching barcode
        const row = document.querySelector(`tr[data-barcode="${barcode}"]`);
        
        if (row) {
          // Find the quantity input in that row
          const qtyInput = row.querySelector('input[type="number"]');
          
          if (qtyInput) {
            // Increment quantity
            const currentQty = parseInt(qtyInput.value) || 0;
            qtyInput.value = currentQty + 1;
            
            // Visual feedback
            flashRow(row);
            playBeep();
            
            // Focus the input briefly
            qtyInput.focus();
            setTimeout(() => qtyInput.blur(), 200);
          }
        } else {
          console.warn("‚ö†Ô∏è Product not found for barcode:", barcode);
          // Optional: show a toast notification here
        }

      } catch (err) {
        console.error("‚ùå Error processing scan:", err);
      }
    };

    socket.onclose = function(e) {
      console.log("üîå Disconnected:", e.code);
      updateStatus("Disconnected", "badge-danger");

      // Auto-reconnect after 3 seconds
      if (!reconnectTimer) {
        reconnectTimer = setTimeout(() => {
          console.log("üîÑ Reconnecting...");
          connectWebSocket();
        }, 3000);
      }
    };

    socket.onerror = function(err) {
      console.error("‚ö†Ô∏è WebSocket error:", err);
      updateStatus("Error", "badge-danger");
    };
  }

  // Start connection
  connectWebSocket();

  // Cleanup
  window.addEventListener("beforeunload", function() {
    if (socket) socket.close();
    if (reconnectTimer) clearTimeout(reconnectTimer);
  });
});
</script>

<style>
/* Smooth transitions for row highlighting */
tr {
  transition: background-color 0.3s ease;
}

#scanner-status {
  font-size: 0.9rem;
  padding: 0.4rem 0.8rem;
}

.green-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #28a745;
}

.green-checkbox:checked {
  background-color: #28a745;
  border-color: #28a745;
}

.form-check-label {
  cursor: pointer;
  font-size: 1rem;
  margin-left: 8px;
  user-select: none;
}

.col-md-6 .form-group label.font-weight-bold {
  color: #495057;
  margin-bottom: 0.5rem;
}
</style>
{% endblock %}