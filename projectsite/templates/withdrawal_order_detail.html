{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="content">
  <div class="container-fluid">
    <h4 class="page-title">Withdrawal Order Details</h4>
    
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Order #{{ order_group_id }}</div>
            <a href="{% url 'withdrawalSales' %}" class="btn btn-secondary btn-sm float-right">
              <i class="la la-arrow-left"></i> Back to Withdrawal Sales
            </a>
          </div>
          
          <div class="card-body">
            <!-- Order Information -->
            <div class="row mb-4">
              <div class="col-md-3">
                <strong>Customer/Store:</strong><br>
                {{ customer_name|default:"N/A" }}
              </div>
              <div class="col-md-3">
                <strong>Sales Channel:</strong><br>
                {{ sales_channel }}
              </div>
              <div class="col-md-3">
                <strong>Payment Status:</strong><br>
                <span class="badge 
                  {% if payment_status == 'PAID' %}badge-success
                  {% elif payment_status == 'UNPAID' %}badge-danger
                  {% elif payment_status == 'PARTIAL' %}badge-warning
                  {% else %}badge-secondary{% endif %}">
                  {{ payment_status_display }}
                </span>
              </div>
              <div class="col-md-3">
                <strong>Date:</strong><br>
                {{ date|date:"Y-m-d H:i" }}
              </div>
            </div>
            
            <!-- Items Table -->
            <h5>Order Items</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Price Type</th>
                    <th>Price</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  {% for withdrawal in withdrawals %}
                  <tr>
                    <td>{{ withdrawal.get_item_display }}</td>
                    <td>{{ withdrawal.quantity|floatformat:2 }}</td>
                    <td>
                      {% if withdrawal.price_type_display %}
                        {{ withdrawal.price_type_display }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if withdrawal.unit_price_display %}
                        ₱{{ withdrawal.unit_price_display|floatformat:2 }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if withdrawal.subtotal %}
                        ₱{{ withdrawal.subtotal|floatformat:2 }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  {% if payment_history %}
                    {% for payment in payment_history %}
                    <tr>
                      <th colspan="4" class="text-right">{{ payment.label }}:</th>
                      <th>₱{{ payment.amount|floatformat:2|intcomma }}</th>
                    </tr>
                    {% endfor %}
                    <tr class="table-success">
                      <th colspan="4" class="text-right"><strong>Total Paid:</strong></th>
                      <th><strong>₱{{ total_amount|floatformat:2|intcomma }}</strong></th>
                    </tr>
                  {% elif payment_status == 'PARTIAL' %}
                  <tr>
                    <th colspan="4" class="text-right">Partial Payment:</th>
                    <th>₱{{ total_amount|floatformat:2|intcomma }}</th>
                  </tr>
                  {% else %}
                  <tr>
                    <th colspan="4" class="text-right">Total:</th>
                    <th>₱{{ total_amount|floatformat:2|intcomma }}</th>
                  </tr>
                  {% endif %}
                </tfoot>
              </table>
            </div>
            
            <!-- Update Payment Button -->
            {% if payment_status != 'PAID' %}
            <div class="mt-3">
              <button type="button" class="btn btn-success" data-toggle="modal" data-target="#updatePaymentModal">
                <i class="la la-money"></i> Update Payment Status
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Update Payment Modal -->
<div class="modal fade" id="updatePaymentModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'withdrawal-order-update-payment' order_group_id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Update Payment Status</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Customer: {{ customer_name }}</label>
          </div>
          <div class="form-group">
            <label>Current Status: <strong>{{ payment_status_display }}</strong></label>
          </div>
          <div class="form-group">
            <label>New Payment Status</label>
            <select name="payment_status" id="paymentStatusSelect" class="form-control" required>
              <option value="PAID">Paid</option>
              <option value="PARTIAL">Partial Payment</option>
              <option value="UNPAID">Unpaid</option>
            </select>
          </div>
          <div class="form-group" id="totalPriceField" style="display:none;">
            <label>Total Price Paid <span class="text-danger">*</span></label>
            <input type="number" step="0.01" name="total_price" id="totalPriceInput" class="form-control" placeholder="Enter total price paid">
            <small class="form-text text-muted">Enter the full price for this order</small>
          </div>
          <div class="form-group" id="paidAmountField" style="display:none;">
            <label>Partial Amount Paid <span class="text-danger">*</span></label>
            <input type="number" step="0.01" name="paid_amount" id="paidAmountInput" class="form-control" placeholder="Enter partial amount paid">
            <small class="form-text text-muted">Enter the partial payment received</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Function to show/hide price fields based on payment status
    function updatePriceFields() {
        var status = $('#paymentStatusSelect').val();
        
        if (status === 'PAID') {
            $('#totalPriceField').show();
            $('#totalPriceInput').attr('required', true);
            $('#paidAmountField').hide();
            $('#paidAmountInput').attr('required', false);
        } else if (status === 'PARTIAL') {
            $('#totalPriceField').hide();
            $('#totalPriceInput').attr('required', false);
            $('#paidAmountField').show();
            $('#paidAmountInput').attr('required', true);
        } else {
            // UNPAID
            $('#totalPriceField').hide();
            $('#totalPriceInput').attr('required', false);
            $('#paidAmountField').hide();
            $('#paidAmountInput').attr('required', false);
        }
    }
    
    // Trigger on change
    $('#paymentStatusSelect').on('change', updatePriceFields);
    
    // Trigger on modal open to show initial state
    $('#updatePaymentModal').on('shown.bs.modal', function() {
        updatePriceFields();
    });
});
</script>
{% endblock %}
