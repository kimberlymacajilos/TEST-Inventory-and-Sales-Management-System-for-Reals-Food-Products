{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="content">
  <div class="container-fluid">
    <h4 class="page-title">Bulk Withdraw</h4>

    <div class="card">
      <div class="card-body"> 
        <form method="post" action="{% url 'withdraw-item' %}">
          {% csrf_token %}

          <!-- Item type selection -->
          <div class="form-group">
            <label for="item_type">Select Item Type</label>
            <select name="item_type" id="item_type" class="form-control" required>
              <option value="">Select Type</option>
              <option value="PRODUCT">Product</option>
              <option value="RAW_MATERIAL">Raw Material</option>
            </select>
          </div>

          <!-- Reason -->
          <div class="form-group mt-2">
            <label for="reason">Reason</label>
            <select name="reason" id="reason" class="form-control" required>
              <option value="">Select Reason</option>
              <option value="SOLD">Sold</option>
              <option value="EXPIRED">Expired</option>
              <option value="DAMAGED">Damaged</option>
              <option value="RETURNED">Returned</option>
              <option value="OTHERS">Others</option>
            </select>
          </div>

          <div id="sales-price-section" style="display:none; margin-top:10px;">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="sales_channel">Sales Channel</label>
                <select name="sales_channel" id="sales_channel" class="form-control">
                  <option value="">-- Select --</option>
                  <option value="ORDER">Order</option>
                  <option value="CONSIGNMENT">Consignment</option>
                  <option value="RESELLER">Reseller</option>
                  <option value="PHYSICAL_STORE">Physical Store</option>
                </select>
              </div>

              <!-- Single field for price -->
              <div class="form-group col-md-6" id="price_input_wrapper">
                <label for="price_input">Price</label>
                <input list="priceOptions" name="price_input" id="price_input" 
                       class="form-control" 
                       placeholder="Enter custom price or select UNIT/SRP">
                <datalist id="priceOptions">
                  <option value="UNIT">
                  <option value="SRP">
                </datalist>
                <small class="form-text text-muted">
                  ⚠️ Entering a number will be treated as a custom price. Selecting UNIT or SRP will use that price type.
                </small>
              </div>
            </div>
          </div>

          <!-- Products table -->
          <div id="products_table" class="mt-3" style="display:none;">
            <h5>Products</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Stock</th>
                  <th>Withdraw Quantity</th>
                  <th class="discount-col" style="display:none;">Discount (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr>
                  <td>
                    {{ product.product_type.name }} - {{ product.variant.name }} - 
                    {{ product.size.size_label }} {{ product.size_unit.unit_name }}
                  </td>
                  <td class="stock-cell" data-stock="{{ product.productinventory.total_stock }}">
                    {{ product.productinventory.total_stock|floatformat:0 }}
                  </td>
                  <td>
                    <input type="number" step="0.01" name="product_{{ product.id }}" 
                           class="form-control withdraw-input" 
                           data-item-id="{{ product.id }}"
                           data-item-type="PRODUCT"
                           data-max-stock="{{ product.productinventory.total_stock }}"
                           min="0">
                    <small class="form-text validation-msg"></small>
                  </td>
                  <td class="discount-col" style="display:none;">
                    <input type="number" step="0.01" min="0" 
                           name="discount_{{ product.id }}" 
                           class="form-control" 
                           list="discountOptions" 
                           placeholder="Type or select %">
                    <datalist id="discountOptions">
                      {% for d in discounts %}
                        <option value="{{ d.value }}">{{ d.name }} ({{ d.value }}%)</option>
                      {% endfor %}
                    </datalist>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Raw materials table -->
          <div id="rawmaterials_table" class="mt-3" style="display:none;">
            <h5>Raw Materials</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Raw Material</th>
                  <th>Stock</th>
                  <th>Withdraw Quantity</th>
                </tr>
              </thead>
              <tbody>
                {% for material in rawmaterials %}
                <tr>
                  <td>{{ material.name }} ({{ material.unit.unit_name }})</td>
                  <td class="stock-cell" data-stock="{{ material.rawmaterialinventory.total_stock }}">
                    {{ material.rawmaterialinventory.total_stock|floatformat:0 }}
                  </td>
                  <td>
                    <input type="number" step="0.01" name="material_{{ material.id }}" 
                           class="form-control withdraw-input" 
                           data-item-id="{{ material.id }}"
                           data-item-type="RAW_MATERIAL"
                           data-max-stock="{{ material.rawmaterialinventory.total_stock }}"
                           min="0">
                    <small class="form-text validation-msg"></small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Submit -->
          <div class="form-group mt-3">
            <button type="submit" id="submit-btn" class="btn btn-warning btn-rounded">Withdraw Selected</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS to toggle -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const typeSelect = document.getElementById("item_type");
  const reasonField = document.getElementById("reason");
  const salesPriceSection = document.getElementById("sales-price-section");
  const discountCols = document.querySelectorAll(".discount-col");
  const priceInput = document.getElementById("price_input");
  const salesChannel = document.getElementById("sales_channel");
  const prodTable = document.getElementById("products_table");
  const matTable = document.getElementById("rawmaterials_table");

  function toggleItemTables() {
    if (typeSelect.value === "PRODUCT") {
      prodTable.style.display = "block";
      matTable.style.display = "none";
    } else if (typeSelect.value === "RAW_MATERIAL") {
      matTable.style.display = "block";
      prodTable.style.display = "none";
    } else {
      prodTable.style.display = "none";
      matTable.style.display = "none";
    }
  }

  function toggleSections() {
    if (reasonField.value === "SOLD") {
      salesPriceSection.style.display = "block";
      discountCols.forEach(col => col.style.display = "table-cell");
    } else {
      salesPriceSection.style.display = "none";
      discountCols.forEach(col => col.style.display = "none");
    }
  }

  function updateReasonOptions() {
    const itemType = typeSelect.value;
    const soldOption = reasonField.querySelector('option[value="SOLD"]');
    
    if (itemType === "RAW_MATERIAL") {
      // Hide SOLD option for raw materials
      if (soldOption) {
        soldOption.style.display = "none";
        soldOption.disabled = true;
      }
      // If SOLD was selected, reset to empty
      if (reasonField.value === "SOLD") {
        reasonField.value = "";
        toggleSections();
      }
    } else {
      // Show SOLD option for products
      if (soldOption) {
        soldOption.style.display = "block";
        soldOption.disabled = false;
      }
    }
  }

  typeSelect.addEventListener("change", function() {
    toggleItemTables();
    updateReasonOptions();
  });
  reasonField.addEventListener("change", toggleSections);

  toggleItemTables();
  updateReasonOptions();
  toggleSections();

  // Real-time stock validation
  const withdrawInputs = document.querySelectorAll(".withdraw-input");
  const submitBtn = document.getElementById('submit-btn');
  let validationErrors = new Set();

  withdrawInputs.forEach(input => {
    input.addEventListener("input", function() { validateWithdrawQuantity(this); });
    input.addEventListener("blur", function() { validateWithdrawQuantity(this); });
  });

  function validateWithdrawQuantity(input) {
    const maxStock = parseFloat(input.dataset.maxStock);
    const withdrawQty = parseFloat(input.value) || 0;
    const validationMsg = input.nextElementSibling;
    const inputName = input.name;

    validationErrors.delete(inputName);

    if (withdrawQty === 0) {
      validationMsg.textContent = "";
      validationMsg.className = "form-text";
      input.style.borderColor = "";
      updateSubmitButton();
      return;
    }

    if (withdrawQty > maxStock) {
      validationMsg.textContent = `❌ Exceeds available stock! (Max: ${maxStock.toFixed(2)})`;
      validationMsg.className = "form-text text-danger font-weight-bold";
      input.style.borderColor = "#dc3545";
      input.style.backgroundColor = "#fff3cd";
      validationErrors.add(inputName);
    } else if (withdrawQty < 0) {
      validationMsg.textContent = "❌ Cannot be negative!";
      validationMsg.className = "form-text text-danger font-weight-bold";
      input.style.borderColor = "#dc3545";
      input.style.backgroundColor = "#fff3cd";
      validationErrors.add(inputName);
    } else {
      validationMsg.textContent = `✓ Valid (${withdrawQty.toFixed(2)} / ${maxStock.toFixed(2)})`;
      validationMsg.className = "form-text text-success";
      input.style.borderColor = "#28a745";
      input.style.backgroundColor = "#d4edda";
    }

    updateSubmitButton();
  }

  function updateSubmitButton() {
    if (validationErrors.size > 0) {
      submitBtn.disabled = true;
      submitBtn.classList.remove("btn-warning");
      submitBtn.classList.add("btn-secondary");
      submitBtn.textContent = `⚠️ Fix ${validationErrors.size} error(s) to continue`;
      submitBtn.style.cursor = "not-allowed";
    } else {
      submitBtn.disabled = false;
      submitBtn.classList.remove("btn-secondary");
      submitBtn.classList.add("btn-warning");
      submitBtn.textContent = "Withdraw Selected";
      submitBtn.style.cursor = "pointer";
    }
  }
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    if (validationErrors.size > 0) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      alert(`Cannot submit! Please fix ${validationErrors.size} validation error(s) first.`);
      return false;
    }
  });

});
</script>

{% endblock %}
