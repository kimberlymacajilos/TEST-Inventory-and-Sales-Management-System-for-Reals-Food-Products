{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="content">
  <div class="container-fluid">
    <h4 class="page-title">Bulk Withdraw</h4>

    <div class="card">
      <div class="card-body"> 
        <form method="post" action="{% url 'withdraw-item' %}">
          {% csrf_token %}
          
          <!-- Item type selection -->
          <div class="form-group">
            <label for="item_type">Select Item Type</label>
            <select name="item_type" id="item_type" class="form-control" required>
              <option value="">Select Type</option>
              <option value="PRODUCT">Product</option>
              <option value="RAW_MATERIAL">Raw Material</option>
            </select>
          </div>

          <!-- Reason -->
          <div class="form-group mt-2">
            <label for="reason">Reason</label>
            <select name="reason" id="reason" class="form-control" required>
              <option value="">Select Reason</option>
              <option value="SOLD">Sold</option>
              <option value="EXPIRED">Expired</option>
              <option value="DAMAGED">Damaged</option>
              <option value="RETURNED">Returned</option>
              <option value="OTHERS">Others</option>
            </select>
          </div>

          <!-- Sales section -->
          <div id="sales-price-section" style="display:none; margin-top:10px;">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="sales_channel">Sales Channel</label>
                <select name="sales_channel" id="sales_channel" class="form-control">
                  <option value="">-- Select --</option>
                  <option value="ORDER">Order</option>
                  <option value="CONSIGNMENT">Consignment</option>
                  <option value="RESELLER">Reseller</option>
                  <option value="PHYSICAL_STORE">Physical Store</option>
                </select>
              </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="sales_channel">Sales Channel</label>
                <select name="sales_channel" id="sales_channel" class="form-control">
                  <option value="">-- Select --</option>
                  <option value="ORDER">Order</option>
                  <option value="CONSIGNMENT">Consignment</option>
                  <option value="RESELLER">Reseller</option>
                  <option value="PHYSICAL_STORE">Physical Store</option>
                </select>
              </div>

            <label for="price_type">Price Type</label>
            <select name="price_type" id="price_type">
              <option value="">-- Select --</option>
              <option value="UNIT">Unit Price</option>
              <option value="SRP">SRP</option>
            </select>
          </div>
          
          <!-- Products table -->
          <div id="products_table" class="mt-3" style="display:none;">
            <h5>Products</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Stock</th>
                  <th>Withdraw Quantity</th>
                  <th class="discount-col" style="display:none;">Discount (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr>
                  <td>
                    {{ product.product_type.name }} - {{ product.variant.name }} - 
                    {{ product.size.size_label }} {{ product.size_unit.unit_name }}
                  </td>
                  <td>{{ product.productinventory.total_stock|floatformat:0 }}</td>
                  <td>
                    <input type="number" step="0.01" name="product_{{ product.id }}" 
                           class="form-control" min="0">
                  </td>
                  <td class="discount-col" style="display:none;">
                    <input type="number" step="0.01" min="0" 
                           name="discount_{{ product.id }}" 
                           class="form-control" 
                           list="discountOptions" 
                           placeholder="Type or select %">
                    <datalist id="discountOptions">
                      {% for d in discounts %}
                        <option value="{{ d.value }}">{{ d.name }} ({{ d.value }}%)</option>
                      {% endfor %}
                    </datalist>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Raw materials table -->
          <div id="rawmaterials_table" class="mt-3" style="display:none;">
            <h5>Raw Materials</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Raw Material</th>
                  <th>Stock</th>
                  <th>Withdraw Quantity</th>
                </tr>
              </thead>
              <tbody>
                {% for material in rawmaterials %}
                <tr>
                  <td>{{ material.name }} ({{ material.unit.unit_name }})</td>
                  <td>{{ material.rawmaterialinventory.total_stock|floatformat:0 }}</td>
                  <td>
                    <input type="number" step="0.01" name="material_{{ material.id }}" 
                           class="form-control" min="0">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>



          <!-- Submit -->
          <div class="form-group mt-3">
            <button type="submit" class="btn btn-warning btn-rounded">Withdraw Selected</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS to toggle -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const typeSelect = document.getElementById("item_type");
  const prodTable = document.getElementById("products_table");
  const matTable = document.getElementById("rawmaterials_table");
  const reasonField = document.getElementById("reason");
  const salesPriceSection = document.getElementById("sales-price-section");
  const discountCols = document.querySelectorAll(".discount-col");

  function toggleItemTables() {
    if (typeSelect.value === "PRODUCT") {
      prodTable.style.display = "block";
      matTable.style.display = "none";
    } else if (typeSelect.value === "RAW_MATERIAL") {
      matTable.style.display = "block";
      prodTable.style.display = "none";
    } else {
      prodTable.style.display = "none";
      matTable.style.display = "none";
    }
  }

  function toggleSections() {
    if (reasonField.value === "SOLD") {
      salesPriceSection.style.display = "block";
      discountCols.forEach(col => col.style.display = "table-cell");
    } else {
      salesPriceSection.style.display = "none";
      discountCols.forEach(col => col.style.display = "none");
    }
  }

  typeSelect.addEventListener("change", toggleItemTables);
  reasonField.addEventListener("change", toggleSections);

  toggleItemTables();
  toggleSections();
});
</script>
{% endblock %}
