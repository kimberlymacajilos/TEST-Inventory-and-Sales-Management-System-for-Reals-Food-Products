{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="content">
  <div class="container-fluid">
    <h4 class="page-title">Bulk Withdraw</h4>

    <div class="card">
      <div class="card-body">
        
        <!-- Filter section -->
        <form method="get" id="filter_form" class="mb-3">
          <div class="row align-items-end">
            <!-- Item Type -->
            <div class="col-md-3">
              <label for="item_type">Item Type</label>
              <select name="item_type" id="item_type" class="form-control" required>
                <option value="">-- Select Type --</option>
                <option value="PRODUCT" {% if selected_type == "PRODUCT" %}selected{% endif %}>Product</option>
                <option value="RAW_MATERIAL" {% if selected_type == "RAW_MATERIAL" %}selected{% endif %}>Raw Material</option>
              </select>
            </div>

            <!-- Expiration Date -->
            <div class="col-md-4">
              <label for="expiration_date">Filter by Expiration Date (optional)</label>
              <select name="expiration_date" id="expiration_date" class="form-control" {% if not selected_type %}disabled{% endif %}>
                <option value="">All</option>

                {% if selected_type == "PRODUCT" %}
                  {% for d in product_expirations %}
                    <option value="{{ d.value }}" {% if selected_expiration == d.value %}selected{% endif %}>{{ d.display }}</option>
                  {% endfor %}
                  {% if product_has_no_expiration %}
                    <option value="NONE" {% if selected_expiration == "NONE" %}selected{% endif %}>No expiration</option>
                  {% endif %}
                {% elif selected_type == "RAW_MATERIAL" %}
                  {% for d in material_expirations %}
                    <option value="{{ d.value }}" {% if selected_expiration == d.value %}selected{% endif %}>{{ d.display }}</option>
                  {% endfor %}
                  {% if material_has_no_expiration %}
                    <option value="NONE" {% if selected_expiration == "NONE" %}selected{% endif %}>No expiration</option>
                  {% endif %}
                {% endif %}
              </select>
            </div>
          </div>
        </form>

        <!-- Withdraw form -->
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="item_type" value="{{ selected_type }}">
          <input type="hidden" name="expiration_date" value="{{ selected_expiration }}">

          {% if selected_type == "PRODUCT" %}
          <h5 class="mt-4">Products</h5>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Product</th>
                <th>Stock</th>
                <th>Withdraw Quantity</th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
              <tr>
                <td>
                  {{ product.product_type.name }} - {{ product.variant.name }} - 
                  {{ product.size.size_label }} {{ product.size_unit.unit_name }}
                </td>
                <td>{{ product.filtered_stock|floatformat:0 }}</td>
                <td>
                  <input type="number" step="0.01" name="product_{{ product.id }}" class="form-control" min="0">
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="3">No products found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          {% elif selected_type == "RAW_MATERIAL" %}
          <h5 class="mt-4">Raw Materials</h5>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Raw Material</th>
                <th>Stock</th>
                <th>Withdraw Quantity</th>
              </tr>
            </thead>
            <tbody>
              {% for material in rawmaterials %}
              <tr>
                <td>{{ material.name }} ({{ material.unit.unit_name }})</td>
                <td>{{ material.filtered_stock|floatformat:0 }}</td>
                <td>
                  <input type="number" step="0.01" name="material_{{ material.id }}" class="form-control" min="0">
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="3">No raw materials found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          <!-- Reason -->
          <div class="form-group mt-3">
            <label for="reason">Reason</label>
            <select name="reason" id="reason" class="form-control" required>
              <option value="">-- Select Reason --</option>
              <option value="SOLD">Sold</option>
              <option value="EXPIRED">Expired</option>
              <option value="DAMAGED">Damaged</option>
              <option value="RETURNED">Returned</option>
              <option value="OTHERS">Others</option>
            </select>
          </div>

          <!-- Submit -->
          <div class="form-group mt-3">
            <button type="submit" class="btn btn-warning btn-rounded">Withdraw Selected</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Auto-submit filters -->
<script>
document.getElementById("item_type").addEventListener("change", function() {
  document.getElementById("filter_form").submit();
});
document.getElementById("expiration_date").addEventListener("change", function() {
  document.getElementById("filter_form").submit();
});
</script>
{% endblock %}
