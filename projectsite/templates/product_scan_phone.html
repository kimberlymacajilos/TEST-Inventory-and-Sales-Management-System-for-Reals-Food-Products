<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Phone Scanner - Real's Food Products</title>

    <!-- Bootstrap CSS (minimal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .scanner-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            background: linear-gradient(135deg, #BBD8A3, #F0F1C5);
        }

        .scanner-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .scanner-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .status-badges {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .btn {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
        }

        .reader-wrapper {
            flex: 1;
            position: relative;
            width: 100%;
            min-height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        #reader {
            width: 100%;
            height: 100%;
            border-radius: 15px;
        }

        .scan-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .scan-overlay::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70vmin;
            max-width: 85%;
            aspect-ratio: 1/1;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 0 200vmax rgba(0,0,0,0.5) inset;
            border-radius: 12px;
        }

        .scan-overlay::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70vmin;
            max-width: 85%;
            aspect-ratio: 1/1;
            border-radius: 12px;
            box-shadow:
                0 -16px 0 -14px #00d1b2,
                16px 0 0 -14px #00d1b2,
                0 16px 0 -14px #00d1b2,
                -16px 0 0 -14px #00d1b2;
        }

        .mobile-optimized {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide scrollbar for cleaner look */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Ensure full screen on mobile */
        html, body {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body class="mobile-optimized">
    <div class="scanner-container">
        <div class="scanner-header">
            <h1 class="scanner-title">Real's Phone Scanner</h1>
            <div class="status-badges">
                <span id="scanner-conn" class="badge badge-secondary">WS: Connectingâ€¦</span>
                <span id="scanner-cam" class="badge badge-info">Camera: -</span>
                <span id="scanner-last" class="badge badge-light">Last: -</span>
            </div>
        </div>

        <div class="controls">
            <button id="toggleTorch" type="button" class="btn btn-warning btn-sm" disabled>ðŸ”¦ Torch</button>
            <button id="toggleSound" type="button" class="btn btn-outline-light btn-sm" aria-pressed="true">ðŸ”Š Sound: On</button>
        </div>

        <div class="reader-wrapper">
            <div id="reader"></div>
            <div class="scan-overlay" aria-hidden="true"></div>
        </div>

        <audio id="beep" preload="auto">
            <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
        </audio>
    </div>

    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const connBadge = document.getElementById("scanner-conn");
            const camBadge = document.getElementById("scanner-cam");
            const lastBadge = document.getElementById("scanner-last");
            const torchBtn = document.getElementById("toggleTorch");
            const soundBtn = document.getElementById("toggleSound");
            const beep = document.getElementById('beep');

            let playSound = true;
            let socket = null;
            let reconnectAttempts = 0;
            let html5QrCode = null;
            let lastScanned = "";
            let lastTime = 0;
            let torchOn = false;

            function updateConn(status, cls){
                connBadge.textContent = `WS: ${status}`;
                connBadge.className = `badge ${cls}`;
            }

            function updateCam(label){
                camBadge.textContent = `Camera: ${label||'-'}`;
            }

            function updateLast(code){
                lastBadge.textContent = `Last: ${code||'-'}`;
            }

            function wsUrl(){
                const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
                return proto + location.host + '/ws/scan/';
            }

            function connectSocket(){
                try { if (socket) { socket.close(); } } catch(e){}
                updateConn('Connectingâ€¦','badge-secondary');
                socket = new WebSocket(wsUrl());
                socket.onopen = () => { reconnectAttempts = 0; updateConn('Connected','badge-success'); };
                socket.onclose = () => {
                    updateConn('Disconnected','badge-danger');
                    const timeout = Math.min(10000, 1000 * Math.pow(2, reconnectAttempts++));
                    setTimeout(connectSocket, timeout);
                };
                socket.onerror = () => { updateConn('Error','badge-danger'); };
            }

            function sendScan(code){
                if (!code) return;
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ barcode: code }));
                }
            }

            async function startCamera(){
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

                // Calculate optimal size for mobile
                const containerWidth = document.querySelector('.reader-wrapper').offsetWidth - 20;
                const aspect = Math.min(containerWidth, window.innerHeight * 0.6);

                try {
                    // Get available cameras and find back camera
                    const cameras = await Html5Qrcode.getCameras();
                    if (!cameras || !cameras.length) {
                        alert('No cameras found.');
                        return;
                    }

                    const backCamera = cameras.find(c => (c.label||'').toLowerCase().includes('back')) || cameras[0];

                    await html5QrCode.start(
                        backCamera.id,
                        {
                            fps: 15,
                            qrbox: { width: aspect, height: aspect },
                            experimentalFeatures: {
                                useBarCodeDetectorIfSupported: false
                            }
                        },
                        onScan
                    );
                    updateCam('Back Camera');
                    // Try enabling torch capability check (may fail silently)
                    torchBtn.disabled = false;
                } catch (err) {
                    console.error('Camera start failed:', err);
                    alert('Failed to start camera. Please allow camera permission.');
                }
            }

            async function toggleTorch(){
                if (!html5QrCode) return;
                try {
                    await html5QrCode.applyVideoConstraints({
                        advanced: [{ torch: !torchOn }],
                        facingMode: 'environment'
                    });
                    torchOn = !torchOn;
                    torchBtn.classList.toggle('btn-warning', !torchOn);
                    torchBtn.classList.toggle('btn-success', torchOn);
                    torchBtn.textContent = torchOn ? 'ðŸ”¦ Torch: On' : 'ðŸ”¦ Torch';
                } catch(e) {
                    // Torch not supported
                    torchBtn.disabled = true;
                }
            }

            function onScan(decodedText){
                const now = Date.now();
                // Debounce: ignore scans within 800ms
                if (now - lastTime < 800) return;
                // Suppress duplicates
                if (decodedText === lastScanned) return;

                lastScanned = decodedText;
                lastTime = now;

                updateLast(decodedText);
                if (playSound) { try { beep.currentTime = 0; beep.play(); } catch(e){} }
                if (navigator.vibrate) { navigator.vibrate(50); }
                sendScan(decodedText);

                // clear last after 1.2s to allow same code again later
                setTimeout(() => { lastScanned = ""; }, 1200);
            }

            // Initialize camera and socket connection
            startCamera().catch(err => {
                console.error('Camera error:', err);
                alert('Camera access failed. Use HTTPS when on phone.');
            });

            torchBtn.addEventListener('click', toggleTorch);
            soundBtn.addEventListener('click', () => {
                playSound = !playSound;
                soundBtn.classList.toggle('btn-outline-light', playSound);
                soundBtn.classList.toggle('btn-light', !playSound);
                soundBtn.textContent = playSound ? 'ðŸ”Š Sound: On' : 'ðŸ”‡ Sound: Off';
            });

            connectSocket();
        });
    </script>
</body>
</html>
